<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-Time Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="phone">

    <div class="header">Real-Time Analysis</div>

    <div class="lesson-info">
        <div class="lesson-name">{{ lesson.name }}</div>
        <div class="lesson-time">{{ lesson.time }}</div>
    </div>

    <div class="section">
        <h3 class="center-title">Classroom Map</h3>
        <div class="classroom">
            {% for b in blocks %}
                {% if b.attention >= 70 %}
                    <div class="spot green" data-value="{{ b.attention }}"></div>
                {% elif b.attention >= 50 %}
                    <div class="spot yellow" data-value="{{ b.attention }}"></div>
                {% else %}
                    <div class="spot red" data-value="{{ b.attention }}"></div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('overview')">Overview</div>
        <div class="tab" onclick="showTab('graphs')">Graphs</div>
        <div class="tab" onclick="showTab('suggestions')">Suggestions</div>
    </div>

    <div class="tab-content active" id="overview">
        <div class="overview-grid">
            {% for k, v in overview.items() %}
                <div class="overview-card">
                    <div class="overview-title">{{ k }}</div>
                    <div class="overview-value">{{ v }}</div>
                </div>
            {% endfor %}
            <div class="overview-card">
                <div class="overview-title">Max Average Attention</div>
                <div class="overview-value">{{ max_attention }}%</div>
            </div>
            <div class="overview-card">
                <div class="overview-title">Min Average Attention</div>
                <div class="overview-value">{{ min_attention }}%</div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="graphs">
        <div class="graph-switch">
            <button id="btnLine" class="active" onclick="showGraph('line')">Over Time</button>
            <button id="btnPie" onclick="showGraph('pie')">Distribution</button>
        </div>

        <div class="avg-label">Average Attention: {{ avg_attention }}%</div>

        <canvas id="lineChart"></canvas>
        <canvas id="pieChart" style="display:none;"></canvas>
    </div>

    <div class="tab-content" id="suggestions">
        <div class="suggestion-card">
            {% for s in suggestions %}
                <div class="suggestion-item">{{ s }}</div>
            {% endfor %}
        </div>

        <div class="ai-box">
            <div class="ai-title">Ask AI</div>
            <input type="text" placeholder="Ask about improving attention...">
            <button>Ask</button>
        </div>
    </div>

    <div class="new-lesson-btn-container">
        <a href="/start" class="main-btn">New Lesson</a>
    </div>

</div>

<script>
function showTab(id) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(id).classList.add('active');
}

function showGraph(type) {
    document.getElementById('lineChart').style.display = type === 'line' ? 'block' : 'none';
    document.getElementById('pieChart').style.display = type === 'pie' ? 'block' : 'none';
    document.getElementById('btnLine').classList.toggle('active', type === 'line');
    document.getElementById('btnPie').classList.toggle('active', type === 'pie');
}

new Chart(lineChart, {
    type: 'line',
    data: {
        labels: ['0','10','20','30','40','50'],
        datasets: [{
            data: {{ attention_time }},
            borderColor: '#7c3aed',
            backgroundColor: 'rgba(124,58,237,0.25)',
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: { y: { min: 0, max: 100 } }
    }
});

new Chart(pieChart, {
    type: 'pie',
    data: {
        labels: [{% for k in attention_distribution.keys() %}'{{ k }}',{% endfor %}],
        datasets: [{
            data: [{% for v in attention_distribution.values() %}{{ v }},{% endfor %}],
            backgroundColor: ['#7c3aed','#a78bfa','#d8b4fe']
        }]
    }
});
</script>

</body>
</html>